FROM ubuntu:18.04

WORKDIR /app

RUN apt-get update && \
    apt-get install -y software-properties-common && \
    rm -rf /var/lib/apt/lists/*

RUN add-apt-repository ppa:deadsnakes/ppa
RUN apt-get update && apt-get install -y \
      ruby-full python3.6 python3-pip rsync curl git

RUN gem install bundler

ENV LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    CONNECT_AUTH_TYPE=in \
    KAT_ENV=production \
    FLASK_ENV=production

RUN python3 --version
#RUN command -v pip
RUN command -v pip3

RUN pip3 install pipenv
ADD Pipfile Pipfile.lock ./
RUN pipenv install

RUN curl https://get.helm.sh/helm-v3.1.0-linux-amd64.tar.gz --output helm_bin.tar.gz
RUN tar -zxvf helm_bin.tar.gz
RUN mv linux-amd64/helm /usr/local/bin
RUN rm helm_bin.tar.gz
RUN rm -rf linux-amd64

RUN git config --global user.email "you@example.com"; \
    git config --global user.name "Your Name"

ADD . .

RUN mkdir /app/lols
ENV TEST_TMP_ROOT /app/lols

RUN whereis ruby
RUN whereis bundle

CMD ["pipenv", "run", "python3", "-m", "unittest"]